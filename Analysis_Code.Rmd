---
title: "Analysis_Code"
output: html_document
date: "2024-11-20"
---

To Do:

Extract data from API 
Categorize the neighborhoods by the criteria

Julia: grocery store distance
Amia: vehicles
Rosie: income

### Extract Data from API:  

HFAI  

```{r}
library(jsonlite)
library(tidyverse)

hfai_url <- "https://services1.arcgis.com/mVFRs7NF4iFitgbY/arcgis/rest/services/Hfai/FeatureServer/0/query?where=1%3D1&outFields=*&outSR=4326&f=json"

jsonData <- read_json(hfai_url, simplifyVector = TRUE)

hfai <- jsonData$features$attributes %>% 
  select(OBJECTID, CSA2010, hfai15, Shape__Area, Shape__Length)
head(hfai)
```


Median Income
Notes - use threshold of federal poverty level for a family of 4 ($31,200 in 2024). classify neighbourhoods as 1 where median income is 185% of this or less (in this case $57,720)

```{r}
library(jsonlite)
library(tidyverse)

income_url <- "https://services1.arcgis.com/mVFRs7NF4iFitgbY/arcgis/rest/services/Mhhi/FeatureServer/0/query?outFields=*&where=1%3D1&f=geojson"

jsonData <- read_json(income_url, simplifyVector = TRUE)

med_income <- jsonData$features$properties %>% 
  select(OBJECTID, CSA2010, mhhi22, Shape__Area, Shape__Length)

income_table_for_joining <- med_income %>%
  mutate(income_boolean = ifelse(mhhi22 < 57720, 1, 0)) %>%
  select(CSA2010, income_boolean, median_income = mhhi22)
```

Percent of Vehicles Available

```{r}
library(jsonlite)
library(tidyverse)

vehicles_url <- "https://services1.arcgis.com/mVFRs7NF4iFitgbY/arcgis/rest/services/Novhcl/FeatureServer/0/query?where=1%3D1&outFields=*&outSR=4326&f=json"

jsonData <- read_json(vehicles_url, simplifyVector = TRUE)

vehicles <- jsonData$features$attributes %>%
select(OBJECTID, CSA2010, novhcl22, Shape__Area, Shape__Length)

vehicle_table_for_joining <- vehicles %>%
  mutate(vehicle_boolean = ifelse(novhcl22 > 30, 1, 0)) %>%
  select(CSA2010, vehicle_boolean, percnt_no_vehicle = novhcl22)
head(vehicle_table_for_joining)

```

Grocery Store Location

```{r}
library(jsonlite)
library(tidyverse)

# install.packages("pak")
library(pak)
library(purrr)
#pak::pkg_install("elipousson/mapbaltimore", dependencies = TRUE)
library(mapbaltimore)
grocery_store_url <- "https://services1.arcgis.com/UWYHeuuJISiGmgXx/arcgis/rest/services/Grocery_Store/FeatureServer/0/query?where=1%3D1&outFields=*&outSR=4326&f=json"

jsonData <- read_json(grocery_store_url, simplifyVector = TRUE)

grocery_stores <- jsonData$features$attributes

# remove store in row 46 because it is outside of the zone and doesn't register as an address

add <- grocery_stores$address[1:45]

csas_with_store <- map(.x = add, .f = ~ get_area(type="csa", location = .x)$name)

# assign manually stores which did not get assigned a CSA

csas_with_store[[19]] <- "South Baltimore"
csas_with_store[[38]] <- "South Baltimore" 

csas_with_store <- unlist(csas_with_store)

grocery_stores_2 <- cbind(grocery_stores[1:45,], csas_with_store) %>% 
  select(OBJECTID, latitude, longitude, address, storename, csas_with_store) %>% 
  add_count(csas_with_store, name = "store_number") %>% 
  group_by(csas_with_store) %>% 
  mutate(store_number = 1:n()) %>% 
  pivot_wider(id_cols = csas_with_store, names_from = store_number, values_from = c(address, latitude, longitude, storename)) %>% 
  mutate(has_store = 1)

# create vector with CSA names

csas <- data.frame(csa = vehicles$CSA2010)

grocery_store_join <- left_join(csas, grocery_stores_2, by = join_by(csa == csas_with_store)) %>% 
  mutate(has_store = ifelse(is.na(grocery_store_join$has_store),0,1)) %>% 
  relocate(has_store, .after = csa) %>% 
  rename(CSA2010 = csa)
head(grocery_store_join)
```

```{r}
contains_store <- function(n) {
  if(n %in% csas_with_store) {
    1
  } else {
    0
  }
}

grocery_stores_csa <- data.frame(cbind(csas, map_dbl(.x = csas, .f = ~contains_store(.x))))
colnames(grocery_stores_csa) <- c("CSA2010", "groc_store")
#grocery_stores_csa

# grocery store 1 or 0, grocery store #1 address, grocery sore #1 name, repeat for #2-#4

#data.frame(cbind(mapbaltimore::csas$name, vehicles$CSA2010))
#vehicles$CSA2010 %in% mapbaltimore::csas$name
#length(mapbaltimore::csas$name)
#length(vehicles$CSA2010)
mapbaltimore::csas$name %in% vehicles$CSA2010
#mapbaltimore::csas$name[51]
```
### Which areas have over 30% of households without a vehicle available?

```{r}
library(dplyr)

vehicles_30 <- vehicles %>% 
  filter(novhcl22 > 30)
```

### Joining income, vehicle and grocery store data
```{r}
grocery_table_for_joining <- grocery_stores_csa %>%
  mutate(groc_store = as.numeric(groc_store))
neighbourhood_priority_levels <- income_table_for_joining %>%
  left_join(vehicle_table_for_joining, by = 'CSA2010') %>%
  left_join(grocery_table_for_joining, by = 'CSA2010') %>%
  mutate(number_criteria_met = income_boolean + vehicle_boolean + groc_store, hfai_priority = case_when(number_criteria_met == 3 ~ 'High', number_criteria_met == 2 ~ 'Medium', number_criteria_met < 2 ~ 'Low'))

neighbourhood_priority_levels

``` 
# Loading demographic data from API

## Age

### Percent of Population 5-17 years old

```{r}
library(jsonlite)
library(tidyverse)

pop_children_url <- "https://services1.arcgis.com/mVFRs7NF4iFitgbY/arcgis/rest/services/Age18_/FeatureServer/0/query?where=1%3D1&outFields=*&outSR=4326&f=json"

jsonData <- read_json(pop_children_url, simplifyVector = TRUE)

pop_children <- jsonData$features$attributes %>% 
  select(OBJECTID, CSA2010, age18_22, Shape__Area, Shape__Length)

head(pop_children)
```

### Percent of Population 18-24 years old

```{r}
library(jsonlite)
library(tidyverse)

pop_youngadult_url <- "https://services1.arcgis.com/mVFRs7NF4iFitgbY/arcgis/rest/services/Age24_/FeatureServer/0/query?where=1%3D1&outFields=*&outSR=4326&f=json"

jsonData <- read_json(pop_youngadult_url, simplifyVector = TRUE)

pop_youngadult <- jsonData$features$attributes %>% 
  select(OBJECTID, CSA2010, age24_22, Shape__Area, Shape__Length)

head(pop_youngadult)
```

### Percent of Population 24-64 years old

```{r}
library(jsonlite)
library(tidyverse)

pop_adult_url <- "https://services1.arcgis.com/mVFRs7NF4iFitgbY/arcgis/rest/services/Age64_/FeatureServer/0/query?where=1%3D1&outFields=*&outSR=4326&f=json"

jsonData <- read_json(pop_adult_url, simplifyVector = TRUE)

pop_adult <- jsonData$features$attributes %>% 
  select(OBJECTID, CSA2010, age64_22, Shape__Area, Shape__Length)

head(pop_adult)
```

### Percent of Population 65 and older

```{r}
library(jsonlite)
library(tidyverse)

pop_elderly_url <- "https://services1.arcgis.com/mVFRs7NF4iFitgbY/arcgis/rest/services/Age65_/FeatureServer/0/query?where=1%3D1&outFields=*&outSR=4326&f=json"

jsonData <- read_json(pop_elderly_url, simplifyVector = TRUE)

pop_elderly <- jsonData$features$attributes %>% 
  select(OBJECTID, CSA2010, age65_22, Shape__Area, Shape__Length)

head(pop_elderly)
```

## Race

### Racial Diversity Index

The percent chance that two people picked at random within an area will be of a different race/ethnicity. This number does not reflect which race/ethnicity is predominant within an area. The higher the value, the more racially and ethnically diverse an area.

```{r}
library(jsonlite)
library(tidyverse)

rdi_url <- "https://services1.arcgis.com/mVFRs7NF4iFitgbY/arcgis/rest/services/Racdiv/FeatureServer/0/query?where=1%3D1&outFields=*&outSR=4326&f=json"

jsonData <- read_json(rdi_url, simplifyVector = TRUE)

rdi <- jsonData$features$attributes %>% 
  select(OBJECTID, CSA2010, racdiv22, Shape__Area, Shape__Length)

head(rdi)
```

### Percent of Residents All Other Races

The percentage of persons, out of the total number of persons living in an area, who self-identify as either American Indian, Alaskan Native, Native Hawaiian or Other Pacific Islander, or some other race (non-Hispanic).

```{r}
library(jsonlite)
library(tidyverse)

pop_other_url <- "https://services1.arcgis.com/mVFRs7NF4iFitgbY/arcgis/rest/services/Ppac/FeatureServer/0/query?where=1%3D1&outFields=*&outSR=4326&f=json"

jsonData <- read_json(pop_other_url, simplifyVector = TRUE)

pop_other <- jsonData$features$attributes %>% 
  select(OBJECTID, CSA2010, ppac22, Shape__Area, Shape__Length)

head(pop_other)
```

### Percent of Residents Black/African-American

```{r}
library(jsonlite)
library(tidyverse)

pop_black_url <- "https://services1.arcgis.com/mVFRs7NF4iFitgbY/arcgis/rest/services/Paa/FeatureServer/0/query?where=1%3D1&outFields=*&outSR=4326&f=json"

jsonData <- read_json(pop_black_url, simplifyVector = TRUE)

pop_black <- jsonData$features$attributes %>% 
  select(OBJECTID, CSA2010, paa22, Shape__Area, Shape__Length)

head(pop_black)
```

### Percent of Residents White (Caucasian)

```{r}
library(jsonlite)
library(tidyverse)

pop_white_url <- "https://services1.arcgis.com/mVFRs7NF4iFitgbY/arcgis/rest/services/Pwhite/FeatureServer/0/query?where=1%3D1&outFields=*&outSR=4326&f=json"

jsonData <- read_json(pop_white_url, simplifyVector = TRUE)

pop_white <- jsonData$features$attributes %>% 
  select(OBJECTID, CSA2010, pwhite22, Shape__Area, Shape__Length)

head(pop_white)
```

### Percent of Residents Hispanic

```{r}
library(jsonlite)
library(tidyverse)

pop_hispanic_url <- "https://services1.arcgis.com/mVFRs7NF4iFitgbY/arcgis/rest/services/Phisp/FeatureServer/0/query?where=1%3D1&outFields=*&outSR=4326&f=json"

jsonData <- read_json(pop_hispanic_url, simplifyVector = TRUE)

pop_hispanic <- jsonData$features$attributes %>% 
  select(OBJECTID, CSA2010, phisp22, Shape__Area, Shape__Length)

head(pop_hispanic)
```

### Percent of Resident Asian (Non-Hispanic)

```{r}
library(jsonlite)
library(tidyverse)

pop_asian_url <- "https://services1.arcgis.com/mVFRs7NF4iFitgbY/arcgis/rest/services/Pasi/FeatureServer/0/query?where=1%3D1&outFields=*&outSR=4326&f=json"

jsonData <- read_json(pop_asian_url, simplifyVector = TRUE)

pop_asian <- jsonData$features$attributes %>% 
  select(OBJECTID, CSA2010, pasi22, Shape__Area, Shape__Length)

head(pop_asian)
```

# Demographics for areas with over 30% of households without a vehicle

```{r}
library(dplyr)

# filter demographic datasets
## percent of population 5-17 years old
vehicles_30_children <- pop_children %>% 
  filter(CSA2010 %in% vehicles_30$CSA2010) %>%
  select(CSA2010, age18_22)

## percent of population 18-24 years old
vehicles_30_youngadult <- pop_youngadult %>% 
  filter(CSA2010 %in% vehicles_30$CSA2010) %>%
  select(CSA2010, age24_22)

## percent of population 24-64 years old
vehicles_30_adult <- pop_adult %>% 
  filter(CSA2010 %in% vehicles_30$CSA2010) %>%
  select(CSA2010, age64_22)

## percent of population 65 and older
vehicles_30_elderly <- pop_elderly %>% 
  filter(CSA2010 %in% vehicles_30$CSA2010) %>%
  select(CSA2010, age65_22)

## racial diversity index
vehicles_30_rdi <- rdi %>% 
  filter(CSA2010 %in% vehicles_30$CSA2010) %>%
  select(CSA2010, racdiv22)

## percent of residents all other races
vehicles_30_other <- pop_other %>% 
  filter(CSA2010 %in% vehicles_30$CSA2010) %>%
  select(CSA2010, ppac22)

## percent of residents black/african-american
vehicles_30_black <- pop_black %>% 
  filter(CSA2010 %in% vehicles_30$CSA2010) %>%
  select(CSA2010, paa22)

## percent of residents white
vehicles_30_white <- pop_white %>% 
  filter(CSA2010 %in% vehicles_30$CSA2010) %>%
  select(CSA2010, pwhite22)

## percent of residents hispanic
vehicles_30_hispanic <- pop_hispanic %>% 
  filter(CSA2010 %in% vehicles_30$CSA2010) %>%
  select(CSA2010, phisp22)

## percent of residents asian
vehicles_30_asian <- pop_asian %>% 
  filter(CSA2010 %in% vehicles_30$CSA2010) %>%
  select(CSA2010, pasi22)

# merge datasets
vehicles_30_demo <- vehicles_30_children %>% 
  full_join(vehicles_30_youngadult, by = "CSA2010") %>% 
  full_join(vehicles_30_adult, by = "CSA2010") %>% 
  full_join(vehicles_30_elderly, by = "CSA2010") %>% 
  full_join(vehicles_30_rdi, by = "CSA2010") %>% 
  full_join(vehicles_30_other, by = "CSA2010") %>% 
  full_join(vehicles_30_black, by = "CSA2010") %>% 
  full_join(vehicles_30_white, by = "CSA2010") %>% 
  full_join(vehicles_30_hispanic, by = "CSA2010") %>% 
  full_join(vehicles_30_asian, by = "CSA2010")

head(vehicles_30_demo)
summary(vehicles_30_demo)
```

# Building dashboards with flexdashboard

## Install and load packages

```{r}
#install.packages(c("flexdashboard", "DT", "shiny"))
library(flexdashboard)
library(DT)
library(shiny)
```







